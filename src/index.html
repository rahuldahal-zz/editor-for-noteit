<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor for NoteIT</title>
</head>

<body>

    <nav id="indexNav">
        <div id="links">
            <a href="about">About</a>

            <fb:login-button id="fbBtn" scope="" onlogin="checkLoginState();">
            </fb:login-button>
        </div>
    </nav>
    <div id="backgroundImage"></div>
    <div id="content">
        <h1>Hey, welcome to the <br /> Editor for NoteIT</h1>
        <p>Before you begin, check this video out.</p>
        <button type="button">Watch Video <i class="fi-xnsuxl-videocamera-solid"></i></button>
    </div>

    <!-- <script defer src="https://friconix.com/cdn/friconix.js"> </script> -->
    <script src="./bundled.js"></script>
    <script>
        window.fbAsyncInit = function () {
            FB.init({
                appId: "2869407766617147",
                cookie: true,
                xfbml: true,
                version: "v7.0"
            });

            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });

        };

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        function statusChangeCallback(response) {
            if (response.status === "connected") {
                handleAuthentication(true);

                testAPI()
                    .then((response) => {
                        console.log(JSON.stringify(response));
                        fetch("https://mynoteit.herokuapp.com/api/contributors/create", {
                            method: "post",
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },

                            //make sure to serialize your JSON body
                            body: JSON.stringify(response)
                        })
                            .then(res => res.json())
                            .then(data => console.log(data));
                    })
                    .catch((error) => console.error(error));
            }

            else handleAuthentication(false);
        }

        const fbLogin = document.getElementById("fbBtn");
        fbLogin.addEventListener("onlogin", checkLoginState);


        function checkLoginState() {
            console.log("login button fires this function");
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        }

        function handleAuthentication(isLoggedIn) {
            if (isLoggedIn) {
                console.log("Yes, you are now authenticated");
            }
            else console.log("You are not authenticated");
        }

        function testAPI() {
            return new Promise((resolve, reject) => {
                // code
                FB.api("/me?fields=id,name,first_name,last_name,picture", function (user) {
                    if (user && !user.error) {
                        console.log(user);
                        return resolve(user);
                    }
                    else {
                        reject(user.error);
                    }
                })
            })
        }

    </script>
</body>

</html>